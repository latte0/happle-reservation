# 予約システム E2E テストケース

## 現在のデータ状態（2025-12-23時点）

### プログラム設定

| ID | 名前 | 時間 | 1日上限 | スタッフ設定 | 設備設定 |
|----|------|------|---------|-------------|---------|
| 1 | Program 1 | 30分 | 1 | ALL | Booth1(0-15分) + Booth2(15-30分) |
| 2 | Program Test | 30分 | 500 | ALL | Booth1のみ |
| 3 | Program Test 2 | 60分 | 200 | ALL | Booth1 or Booth2 (0-30分) |
| 5 | Program Test 3 | 60分 | null(上限なし) | ALL | なし |
| 6 | Program New | 30分 | null(上限なし) | ALL | なし |
| 7 | testing program 15 | 30分 | 10 | Staff Test(ID:2)のみ | なし |

### 設備設定

| ID | 名前 | 同時予約可能数 | 1日上限 |
|----|------|--------------|--------|
| 1 | Booth 1 | 1 | 7 |
| 2 | Booth 2 | 1 | null(上限なし) |

### スタッフシフト（2025-12-25）

| ID | 名前 | シフト時間 |
|----|------|-----------|
| 1 | Staff 1 | 10:10-22:00 |
| 2 | Staff Test | 11:00-23:00 |

### 現在の予約状況（2025-12-25）

| 時間 | スタッフ予約 | 設備予約 |
|------|------------|---------|
| 17:00-17:30 | Staff 1, Staff Test | Booth 1, Booth 2 |
| 17:30-17:45 | - | Booth 1 |
| 17:30-18:00 | Staff 1 | - |
| 17:45-18:00 | - | Booth 2 |

---

## テストケース

### 1. プログラム表示条件

#### TC-1.1: 設備が紐づいていないプログラムは非表示
- **対象**: Program Test 3, Program New, testing program 15
- **期待結果**: メニュー一覧に表示されない
- **理由**: `selectable_resource_details` が空

#### TC-1.2: 設備が紐づいているプログラムは表示
- **対象**: Program 1, Program Test, Program Test 2
- **期待結果**: メニュー一覧に表示される

#### TC-1.3: スタッフ設定がSELECTEDでitemsが空のプログラムは非表示
- **条件**: `selectable_instructor_details.type = SELECTED` かつ `items = []`
- **期待結果**: メニュー一覧に表示されない

---

### 2. 時間制約

#### TC-2.1: 30分以内の時間は予約不可
- **操作**: 現在時刻から30分以内の枠を確認
- **期待結果**: 「×」表示、ツールチップ「受付時間前（30分以内）」

#### TC-2.2: 14日後以降の時間は予約不可
- **操作**: 15日後の枠を確認
- **期待結果**: 「×」表示、ツールチップ「受付期間外（14日後以降）」

#### TC-2.3: 営業時間外は予約不可
- **操作**: 09:00や21:00以降の枠を確認
- **期待結果**: 「-」表示、ツールチップ「営業時間外」

#### TC-2.4: 休業日は予約不可
- **操作**: 休業日設定された日を確認
- **期待結果**: 全時間帯「-」表示、ツールチップ「休業日」

---

### 3. 1日予約上限

#### TC-3.1: 上限に達している日は全時間帯予約不可（Program 1）
- **前提**: Program 1 の max_reservable_num_at_day = 1
- **状態**: 2025-12-25に1件予約済み
- **操作**: Program 1を選択し、2025-12-25を確認
- **期待結果**: 全時間帯「×」表示、ツールチップ「1日の予約上限に達しています」

#### TC-3.2: 上限が0のプログラムは全日予約不可
- **前提**: max_reservable_num_at_day = 0
- **期待結果**: 全日全時間帯「×」表示

#### TC-3.3: 上限がnull（未設定）のプログラムは上限なし
- **前提**: Program Test 3 の max_reservable_num_at_day = null
- **期待結果**: 上限による制限なし

#### TC-3.4: 上限未達の日は予約可能
- **前提**: Program Test の max_reservable_num_at_day = 500
- **状態**: 2025-12-24に0件予約
- **期待結果**: 条件を満たす時間帯は「◎」表示

---

### 4. 設備制約

#### TC-4.1: 設備が使用中の時間は予約不可（Program Test）
- **前提**: Program Test は Booth 1 のみ使用、max_cc_reservable_num = 1
- **状態**: 2025-12-25 17:00-17:30 に Booth 1 使用中
- **操作**: Program Test を選択し、17:00を確認
- **期待結果**: 「×」表示、ツールチップ「設備が使用中です」

#### TC-4.2: 設備が空いている時間は予約可能
- **状態**: 2025-12-25 16:00-16:30 に Booth 1 未使用
- **期待結果**: 「◎」表示

#### TC-4.3: 複数設備から選択可能な場合、1つでも空いていれば予約可能（Program Test 2）
- **前提**: Program Test 2 は Booth 1 or Booth 2 を使用
- **状態**: Booth 1 使用中、Booth 2 空き
- **期待結果**: 「◎」表示

#### TC-4.4: terms設定がある場合、各時間帯で設備チェック（Program 1）
- **前提**: Program 1 は 0-15分: Booth 1、15-30分: Booth 2
- **状態**: 17:00開始の場合
  - 17:00-17:15: Booth 1 使用中
  - 17:15-17:30: Booth 2 使用中
- **期待結果**: 「×」表示（両方の設備が使用中）

#### TC-4.5: terms設定で片方の設備が空いていれば予約可能
- **状態**: 16:00開始の場合
  - 16:00-16:15: Booth 1 空き
  - 16:15-16:30: Booth 2 空き
- **期待結果**: 「◎」表示

---

### 5. スタッフ制約

#### TC-5.1: 全スタッフ予約済みの時間は予約不可
- **状態**: 2025-12-25 17:00-17:30 に Staff 1, Staff Test 両方予約済み
- **期待結果**: 「×」表示、ツールチップ「満席」

#### TC-5.2: 1人でもスタッフが空いていれば予約可能
- **状態**: Staff 1 予約済み、Staff Test 空き
- **期待結果**: 「◎」表示

#### TC-5.3: 指定スタッフのみ選択可能（testing program 15）
- **前提**: testing program 15 は Staff Test (ID:2) のみ選択可能
- **状態**: Staff Test がシフト外の時間
- **期待結果**: 「×」表示

#### TC-5.4: スタッフのシフト時間外は予約不可
- **前提**: Staff Test のシフト 11:00-23:00
- **操作**: 10:00の枠を確認
- **期待結果**: Staff Test は選択不可

#### TC-5.5: スタッフの休憩ブロック中は予約不可
- **前提**: スタッフに休憩ブロック（SHIFT_SLOT）が設定されている
- **期待結果**: その時間帯は予約不可

---

### 6. インターバル制約

#### TC-6.1: 既存予約の前後インターバル内は予約不可
- **前提**: before_interval_minutes, after_interval_minutes が設定されている
- **状態**: 17:00-17:30 に予約あり、after_interval = 15分
- **操作**: 17:30の枠を確認
- **期待結果**: 「×」表示、ツールチップ「前後の予約との間隔が必要です」

---

### 7. 予約実行

#### TC-7.1: 正常に予約できる
- **前提**: 全ての制約をクリアした時間枠
- **操作**: 
  1. 店舗選択
  2. プログラム選択
  3. 「◎」の時間枠をクリック
  4. ゲスト情報入力
  5. 予約確定
- **期待結果**: 予約成功、確認画面表示

#### TC-7.2: 設備競合で予約失敗
- **状態**: フロントエンド表示時は「◎」だったが、確定時に他者が予約
- **期待結果**: エラーメッセージ「指定の時間帯で予約することはできません」

#### TC-7.3: 1日上限超過で予約失敗
- **状態**: フロントエンド表示時は上限未達だったが、確定時に上限到達
- **期待結果**: エラーメッセージ「1日当たりの予約上限数を見直してください」

---

### 8. 複合条件

#### TC-8.1: スタッフ空き + 設備使用中 → 予約不可
- **期待結果**: 「×」（設備使用中）

#### TC-8.2: スタッフ満席 + 設備空き → 予約不可
- **期待結果**: 「×」（満席）

#### TC-8.3: スタッフ空き + 設備空き + 1日上限到達 → 予約不可
- **期待結果**: 「×」（1日の予約上限）

#### TC-8.4: 営業時間内 + スタッフシフト外 → 予約不可
- **期待結果**: 「×」（営業時間外）

---

## API検証用 curl コマンド

### スケジュール取得
```bash
# 単日
curl -s "http://localhost:5021/api/choice-schedule?studio_room_id=3&date=2025-12-25&program_id=2" | jq '.'

# 範囲
curl -s "http://localhost:5021/api/choice-schedule-range?studio_room_id=3&date_from=2025-12-23&date_to=2025-12-29&program_id=2" | jq '.'
```

### 予約作成
```bash
curl -X POST "http://localhost:5021/api/reservations/choice" \
  -H "Content-Type: application/json" \
  -d '{
    "studio_room_id": 3,
    "program_id": 2,
    "start_at": "2025-12-26 10:00:00.000",
    "guest_name": "テスト太郎",
    "guest_name_kana": "テストタロウ",
    "guest_email": "test@example.com",
    "guest_phone": "09012345678"
  }' | jq '.'
```

---

## 優先度

| 優先度 | テストケース |
|-------|-------------|
| 高 | TC-4.1, TC-4.4, TC-3.1, TC-5.1, TC-7.1 |
| 中 | TC-1.1, TC-2.1, TC-2.2, TC-4.3, TC-6.1 |
| 低 | TC-2.3, TC-2.4, TC-5.5, TC-8.x |













