<!DOCTYPE html>
<html>
<head>
<title>cache-architecture.md</title>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

<style>
/* https://github.com/microsoft/vscode/blob/master/extensions/markdown-language-features/media/markdown.css */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

body {
	font-family: var(--vscode-markdown-font-family, -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif);
	font-size: var(--vscode-markdown-font-size, 14px);
	padding: 0 26px;
	line-height: var(--vscode-markdown-line-height, 22px);
	word-wrap: break-word;
}

#code-csp-warning {
	position: fixed;
	top: 0;
	right: 0;
	color: white;
	margin: 16px;
	text-align: center;
	font-size: 12px;
	font-family: sans-serif;
	background-color:#444444;
	cursor: pointer;
	padding: 6px;
	box-shadow: 1px 1px 1px rgba(0,0,0,.25);
}

#code-csp-warning:hover {
	text-decoration: none;
	background-color:#007acc;
	box-shadow: 2px 2px 2px rgba(0,0,0,.25);
}

body.scrollBeyondLastLine {
	margin-bottom: calc(100vh - 22px);
}

body.showEditorSelection .code-line {
	position: relative;
}

body.showEditorSelection .code-active-line:before,
body.showEditorSelection .code-line:hover:before {
	content: "";
	display: block;
	position: absolute;
	top: 0;
	left: -12px;
	height: 100%;
}

body.showEditorSelection li.code-active-line:before,
body.showEditorSelection li.code-line:hover:before {
	left: -30px;
}

.vscode-light.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(0, 0, 0, 0.15);
}

.vscode-light.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(0, 0, 0, 0.40);
}

.vscode-light.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-dark.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 255, 255, 0.4);
}

.vscode-dark.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 255, 255, 0.60);
}

.vscode-dark.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

.vscode-high-contrast.showEditorSelection .code-active-line:before {
	border-left: 3px solid rgba(255, 160, 0, 0.7);
}

.vscode-high-contrast.showEditorSelection .code-line:hover:before {
	border-left: 3px solid rgba(255, 160, 0, 1);
}

.vscode-high-contrast.showEditorSelection .code-line .code-line:hover:before {
	border-left: none;
}

img {
	max-width: 100%;
	max-height: 100%;
}

a {
	text-decoration: none;
}

a:hover {
	text-decoration: underline;
}

a:focus,
input:focus,
select:focus,
textarea:focus {
	outline: 1px solid -webkit-focus-ring-color;
	outline-offset: -1px;
}

hr {
	border: 0;
	height: 2px;
	border-bottom: 2px solid;
}

h1 {
	padding-bottom: 0.3em;
	line-height: 1.2;
	border-bottom-width: 1px;
	border-bottom-style: solid;
}

h1, h2, h3 {
	font-weight: normal;
}

table {
	border-collapse: collapse;
}

table > thead > tr > th {
	text-align: left;
	border-bottom: 1px solid;
}

table > thead > tr > th,
table > thead > tr > td,
table > tbody > tr > th,
table > tbody > tr > td {
	padding: 5px 10px;
}

table > tbody > tr + tr > td {
	border-top: 1px solid;
}

blockquote {
	margin: 0 7px 0 5px;
	padding: 0 16px 0 10px;
	border-left-width: 5px;
	border-left-style: solid;
}

code {
	font-family: Menlo, Monaco, Consolas, "Droid Sans Mono", "Courier New", monospace, "Droid Sans Fallback";
	font-size: 1em;
	line-height: 1.357em;
}

body.wordWrap pre {
	white-space: pre-wrap;
}

pre:not(.hljs),
pre.hljs code > div {
	padding: 16px;
	border-radius: 3px;
	overflow: auto;
}

pre code {
	color: var(--vscode-editor-foreground);
	tab-size: 4;
}

/** Theming */

.vscode-light pre {
	background-color: rgba(220, 220, 220, 0.4);
}

.vscode-dark pre {
	background-color: rgba(10, 10, 10, 0.4);
}

.vscode-high-contrast pre {
	background-color: rgb(0, 0, 0);
}

.vscode-high-contrast h1 {
	border-color: rgb(0, 0, 0);
}

.vscode-light table > thead > tr > th {
	border-color: rgba(0, 0, 0, 0.69);
}

.vscode-dark table > thead > tr > th {
	border-color: rgba(255, 255, 255, 0.69);
}

.vscode-light h1,
.vscode-light hr,
.vscode-light table > tbody > tr + tr > td {
	border-color: rgba(0, 0, 0, 0.18);
}

.vscode-dark h1,
.vscode-dark hr,
.vscode-dark table > tbody > tr + tr > td {
	border-color: rgba(255, 255, 255, 0.18);
}

</style>

<style>
/* Tomorrow Theme */
/* http://jmblog.github.com/color-themes-for-google-code-highlightjs */
/* Original theme - https://github.com/chriskempson/tomorrow-theme */

/* Tomorrow Comment */
.hljs-comment,
.hljs-quote {
	color: #8e908c;
}

/* Tomorrow Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-deletion {
	color: #c82829;
}

/* Tomorrow Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-meta,
.hljs-link {
	color: #f5871f;
}

/* Tomorrow Yellow */
.hljs-attribute {
	color: #eab700;
}

/* Tomorrow Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
	color: #718c00;
}

/* Tomorrow Blue */
.hljs-title,
.hljs-section {
	color: #4271ae;
}

/* Tomorrow Purple */
.hljs-keyword,
.hljs-selector-tag {
	color: #8959a8;
}

.hljs {
	display: block;
	overflow-x: auto;
	color: #4d4d4c;
	padding: 0.5em;
}

.hljs-emphasis {
	font-style: italic;
}

.hljs-strong {
	font-weight: bold;
}
</style>

<style>
/*
 * Markdown PDF CSS
 */

 body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe WPC", "Segoe UI", "Ubuntu", "Droid Sans", sans-serif, "Meiryo";
	padding: 0 12px;
}

pre {
	background-color: #f8f8f8;
	border: 1px solid #cccccc;
	border-radius: 3px;
	overflow-x: auto;
	white-space: pre-wrap;
	overflow-wrap: break-word;
}

pre:not(.hljs) {
	padding: 23px;
	line-height: 19px;
}

blockquote {
	background: rgba(127, 127, 127, 0.1);
	border-color: rgba(0, 122, 204, 0.5);
}

.emoji {
	height: 1.4em;
}

code {
	font-size: 14px;
	line-height: 19px;
}

/* for inline code */
:not(pre):not(.hljs) > code {
	color: #C9AE75; /* Change the old color so it seems less like an error */
	font-size: inherit;
}

/* Page Break : use <div class="page"/> to insert page break
-------------------------------------------------------- */
.page {
	page-break-after: always;
}

</style>

<script src="https://unpkg.com/mermaid/dist/mermaid.min.js"></script>
</head>
<body>
  <script>
    mermaid.initialize({
      startOnLoad: true,
      theme: document.body.classList.contains('vscode-dark') || document.body.classList.contains('vscode-high-contrast')
          ? 'dark'
          : 'default'
    });
  </script>
<h1 id="%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3">キャッシュアーキテクチャ</h1>
<h2 id="%E6%A6%82%E8%A6%81">概要</h2>
<p>本システムは、hacomono APIへの負荷軽減とユーザー体験向上のため、多層キャッシュ機構を実装しています。</p>
<h2 id="%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3%E5%9B%B3">アーキテクチャ図</h2>
<h3 id="%E5%85%A8%E4%BD%93%E3%83%95%E3%83%AD%E3%83%BC">全体フロー</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TB
    subgraph "クライアント"
        FE[フロントエンド<br/>Next.js]
    end
    
    subgraph "バックエンド (Render)"
        API[Flask API]
        WH[Webhook Endpoint<br/>/webhook]
        subgraph "インメモリキャッシュ"
            C1[studios_cache<br/>TTL: 10分]
            C2[programs_cache<br/>TTL: 5分]
            C3[studio_rooms_cache<br/>TTL: 5分]
            C4[choice_schedule_cache<br/>TTL: 15分]
            C5[choice_schedule_range_cache<br/>TTL: 15分]
        end
    end
    
    subgraph "外部サービス"
        HACO[hacomono API]
        HACO_WH[hacomono Webhook<br/>予約変更通知]
        GHA[GitHub Actions<br/>cron: 15分ごと]
    end
    
    FE -->|リクエスト| API
    API -->|キャッシュチェック| C1 & C2 & C3 & C4 & C5
    API -->|キャッシュミス| HACO
    HACO_WH -->|予約完了・変更・キャンセル| WH
    WH -->|キャッシュリフレッシュ| API
    GHA -->|定期キャッシュリフレッシュ| API
    
    style C5 fill:#f9f,stroke:#333,stroke-width:2px
    style WH fill:#9f9,stroke:#333,stroke-width:2px
    style HACO_WH fill:#9f9,stroke:#333,stroke-width:2px
</div></code></pre>
<h3 id="%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E6%9B%B4%E6%96%B0%E3%83%95%E3%83%AD%E3%83%BC">キャッシュ更新フロー</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant User as ユーザー
    participant FE as フロントエンド
    participant API as バックエンド
    participant Cache as キャッシュ
    participant Haco as hacomono API
    participant GHA as GitHub Actions
    participant Webhook as hacomono Webhook
    
    Note over Webhook: リアルタイム更新
    Webhook->>API: POST /webhook
    API->>Cache: キャッシュ無効化
    API->>Haco: 該当範囲のデータ取得
    Haco-->>API: スケジュールデータ
    API->>Cache: キャッシュ保存
    
    Note over GHA: 15分ごと（バックアップ）
    GHA->>API: POST /api/cache/refresh
    API->>Haco: 今週・来週のデータ取得
    Haco-->>API: スケジュールデータ
    API->>Cache: キャッシュ保存
    
    Note over User: ユーザーアクセス
    User->>FE: ページ表示
    FE->>API: GET /api/choice-schedule-range
    API->>Cache: キャッシュチェック
    
    alt キャッシュヒット
        Cache-->>API: キャッシュデータ
        API-->>FE: 高速レスポンス (~0.2s)
    else キャッシュミス
        API->>Haco: APIリクエスト
        Haco-->>API: データ
        API->>Cache: キャッシュ保存
        API-->>FE: レスポンス (~2-3s)
    end
    
    FE-->>User: 画面表示
</div></code></pre>
<h3 id="%E4%BA%88%E7%B4%84%E5%AE%8C%E4%BA%86%E6%99%82%E3%81%AE%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E6%9B%B4%E6%96%B0">予約完了時のキャッシュ更新</h3>
<pre><code class="language-mermaid"><div class="mermaid">sequenceDiagram
    participant User as ユーザー
    participant API as バックエンド
    participant Cache as キャッシュ
    participant Haco as hacomono API
    participant BG as バックグラウンド処理
    
    User->>API: POST /api/reservations/choice
    API->>Haco: 予約作成
    Haco-->>API: 成功
    API-->>User: 予約完了レスポンス
    
    Note over API,BG: 非同期処理（レスポンス後）
    API->>BG: キャッシュリフレッシュ開始
    BG->>Cache: 既存キャッシュ無効化
    BG->>Haco: 今週データ取得
    Haco-->>BG: データ
    BG->>Cache: 今週キャッシュ保存
    BG->>Haco: 来週データ取得
    Haco-->>BG: データ
    BG->>Cache: 来週キャッシュ保存
    
    Note over User: 次のユーザーも高速アクセス
</div></code></pre>
<h2 id="%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E4%B8%80%E8%A6%A7">キャッシュ一覧</h2>
<table>
<thead>
<tr>
<th>キャッシュ名</th>
<th>TTL</th>
<th>キーパターン</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>studios_cache</code></td>
<td>10分</td>
<td>(単一)</td>
<td>店舗一覧</td>
</tr>
<tr>
<td><code>programs_cache</code></td>
<td>5分</td>
<td><code>studio_id</code> or <code>&quot;all&quot;</code></td>
<td>プログラム一覧</td>
</tr>
<tr>
<td><code>studio_rooms_cache</code></td>
<td>5分</td>
<td><code>studio_id</code> or <code>&quot;all&quot;</code></td>
<td>スタジオルーム一覧</td>
</tr>
<tr>
<td><code>choice_schedule_cache</code></td>
<td>15分</td>
<td><code>{room_id}:{date}</code></td>
<td>日別スケジュール（基本データ）</td>
</tr>
<tr>
<td><code>choice_schedule_range_cache</code></td>
<td>15分</td>
<td><code>{room_id}:{date_from}:{date_to}:{program_id}</code></td>
<td>週別スケジュール（完全データ）</td>
</tr>
<tr>
<td><code>instructor_studio_map_cache</code></td>
<td>60秒</td>
<td>(単一)</td>
<td>スタッフ-店舗紐付け</td>
</tr>
<tr>
<td><code>resources_cache</code></td>
<td>5分</td>
<td><code>studio_id</code></td>
<td>設備情報</td>
</tr>
</tbody>
</table>
<h2 id="%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%AD%E3%83%BC%E3%81%AE%E8%A8%AD%E8%A8%88">キャッシュキーの設計</h2>
<h3 id="choiceschedulerangecache-%E3%81%AE%E3%82%AD%E3%83%BC%E6%A7%8B%E9%80%A0">choice_schedule_range_cache のキー構造</h3>
<pre class="hljs"><code><div>{studio_room_id}:{date_from}:{date_to}:{program_id or &quot;none&quot;}

例:
- 4:2025-12-25:2025-12-31:7      # 今週 + program_id=7
- 4:2025-12-25:2025-12-31:none   # 今週 + program_idなし
- 4:2026-01-01:2026-01-07:7      # 来週 + program_id=7
</div></code></pre>
<h3 id="%E3%83%95%E3%83%AD%E3%83%B3%E3%83%88%E3%82%A8%E3%83%B3%E3%83%89%E3%81%AE%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3">フロントエンドのリクエストパターン</h3>
<pre><code class="language-mermaid"><div class="mermaid">gantt
    title フロントエンドの週単位リクエスト
    dateFormat  YYYY-MM-DD
    section 今週
    今週表示 (0-6日)     :2025-12-25, 7d
    section 来週
    来週表示 (7-13日)    :2026-01-01, 7d
</div></code></pre>
<p>フロントエンドは <code>currentWeekStart</code> から7日間のデータをリクエストするため、キャッシュもこの単位で分割されます。</p>
<h2 id="%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E6%9B%B4%E6%96%B0%E3%83%88%E3%83%AA%E3%82%AC%E3%83%BC">キャッシュ更新トリガー</h2>
<h3 id="1-hacomono-webhook%E3%83%AA%E3%82%A2%E3%83%AB%E3%82%BF%E3%82%A4%E3%83%A0%E6%9B%B4%E6%96%B0">1. hacomono Webhook（リアルタイム更新）</h3>
<pre class="hljs"><code><div>POST /webhook
</div></code></pre>
<p>hacomonoの管理画面で予約が変更された際に、Webhookでリアルタイムに通知を受け取りキャッシュを更新します。</p>
<p><strong>対応イベントタイプ:</strong></p>
<ul>
<li><code>SCHEDULE_RESERVATION_RESERVE</code> - 予約完了</li>
<li><code>SCHEDULE_RESERVATION_RESERVE_CHANGE</code> - 予約変更</li>
<li><code>SCHEDULE_RESERVATION_CANCEL</code> - 予約キャンセル</li>
</ul>
<p><strong>セットアップ:</strong></p>
<table>
<thead>
<tr>
<th>環境</th>
<th>URL</th>
<th>シークレット</th>
</tr>
</thead>
<tbody>
<tr>
<td>開発</td>
<td><code>http://localhost:5011/webhook</code></td>
<td><code>LgXlSZxYolYGqoPtAnGnJmMd1jSZOony</code></td>
</tr>
<tr>
<td>本番</td>
<td><code>https://happle-reservation-backend.onrender.com/webhook</code></td>
<td><code>EX9duM782dv8oKDXV6ik1bOUoIZkW8hX</code></td>
</tr>
</tbody>
</table>
<ol>
<li>hacomono管理画面でWebhook設定を作成</li>
<li>URL: 上記表を参照</li>
<li>対象イベント: 予約完了、予約変更、予約キャンセル</li>
<li>シークレットを環境変数 <code>HACOMONO_WEBHOOK_SECRET</code> に設定</li>
</ol>
<p><strong>署名検証:</strong></p>
<ul>
<li><code>X-Webhook-Event</code> ヘッダーのHMAC-SHA256署名を検証</li>
<li>タイムスタンプの鮮度チェック（5分以内）</li>
</ul>
<h3 id="2-github-actions-cron">2. GitHub Actions (cron)</h3>
<pre class="hljs"><code><div><span class="hljs-attr">schedule:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">'*/15 * * * *'</span>  <span class="hljs-comment"># 15分ごと</span>
</div></code></pre>
<ul>
<li><strong>対象</strong>: 指定した <code>studio_ids</code> の今週・来週のスケジュール</li>
<li><strong>目的</strong>: 最初のユーザーも高速にアクセスできるようプリキャッシュ、Webhookのバックアップ</li>
</ul>
<h3 id="4-%E4%BA%88%E7%B4%84%E5%AE%8C%E4%BA%86%E6%99%82">4. 予約完了時</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># バックグラウンドでキャッシュリフレッシュ</span>
Thread(target=refresh_cache_background, daemon=<span class="hljs-literal">True</span>).start()
</div></code></pre>
<ul>
<li><strong>対象</strong>: 予約が入った店舗ルームの今週・来週</li>
<li><strong>目的</strong>: 予約状況の即時反映、次のユーザーの高速アクセス</li>
</ul>
<h3 id="5-%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%83%AA%E3%82%AF%E3%82%A8%E3%82%B9%E3%83%88%E6%99%82%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%83%9F%E3%82%B9">5. ユーザーリクエスト時（キャッシュミス）</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># キャッシュミス時、APIから取得後に自動キャッシュ</span>
response_data = refresh_choice_schedule_range_cache(...)
</div></code></pre>
<ul>
<li><strong>対象</strong>: リクエストされた範囲</li>
<li><strong>目的</strong>: 次のユーザーの高速アクセス</li>
</ul>
<h2 id="%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9">パフォーマンス</h2>
<h3 id="%E6%B8%AC%E5%AE%9A%E7%B5%90%E6%9E%9C">測定結果</h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>キャッシュミス</th>
<th>キャッシュヒット</th>
<th>高速化率</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/programs</code></td>
<td>~1.3s</td>
<td>~0.2s</td>
<td><strong>6.5x</strong></td>
</tr>
<tr>
<td><code>/api/choice-schedule-range</code> (7日)</td>
<td>~2-3s</td>
<td>~0.2-0.3s</td>
<td><strong>10x</strong></td>
</tr>
</tbody>
</table>
<h3 id="%E3%83%9C%E3%83%88%E3%83%AB%E3%83%8D%E3%83%83%E3%82%AF%E5%88%86%E6%9E%90">ボトルネック分析</h3>
<pre><code class="language-mermaid"><div class="mermaid">pie title choice-schedule-range の処理時間内訳（キャッシュミス時）
    "choice/schedule API (7日分)" : 40
    "studio_lessons API" : 20
    "shift_slots API (7日分)" : 30
    "reservations API" : 5
    "データ加工" : 5
</div></code></pre>
<h2 id="%E3%83%AA%E3%82%B9%E3%82%AF%E3%81%A8%E5%AF%BE%E7%AD%96">リスクと対策</h2>
<h3 id="1-%E3%82%A4%E3%83%B3%E3%83%A1%E3%83%A2%E3%83%AA%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E6%B6%88%E5%A4%B1">1. インメモリキャッシュの消失</h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>サーバー再起動</td>
<td>全キャッシュ消失</td>
<td>cronが15分以内に再構築</td>
</tr>
<tr>
<td>Renderのコールドスタート</td>
<td>キャッシュなし</td>
<td>初回リクエストで自動構築</td>
</tr>
</tbody>
</table>
<pre><code class="language-mermaid"><div class="mermaid">flowchart LR
    A[サーバー再起動] --> B[キャッシュ消失]
    B --> C{ユーザーアクセス?}
    C -->|Yes| D[キャッシュミス<br/>~3秒で再構築]
    C -->|No| E[cron実行待ち<br/>最大15分]
    D --> F[キャッシュ復旧]
    E --> F
</div></code></pre>
<h3 id="2-%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%81%AE%E6%95%B4%E5%90%88%E6%80%A7">2. キャッシュの整合性</h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>予約後のキャッシュ不整合</td>
<td>空き枠が古い状態で表示</td>
<td>予約完了時にキャッシュリフレッシュ</td>
</tr>
<tr>
<td>hacomono側での直接変更</td>
<td>キャッシュと実データの乖離</td>
<td>TTL 15分で自動更新、cronで定期更新</td>
</tr>
</tbody>
</table>
<h3 id="3-%E3%83%A1%E3%83%A2%E3%83%AA%E4%BD%BF%E7%94%A8%E9%87%8F">3. メモリ使用量</h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>キャッシュ肥大化</td>
<td>メモリ不足</td>
<td>studio_ids指定で対象店舗を限定</td>
</tr>
</tbody>
</table>
<p><strong>現在のキャッシュサイズ見積もり</strong>:</p>
<ul>
<li>1店舗 × 2週間 × 2パターン（今週・来週）= 約4エントリ</li>
<li>1エントリ ≈ 50-100KB</li>
<li>10店舗で約4-8MB（Renderの無料プランでも問題なし）</li>
</ul>
<h3 id="4-github-actions-%E3%81%AE%E5%88%B6%E9%99%90">4. GitHub Actions の制限</h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>無料枠超過</td>
<td>課金発生</td>
<td>15分間隔に設定（月2,880分 &lt; 無料枠3,000分）</td>
</tr>
<tr>
<td>Actions障害</td>
<td>キャッシュ未更新</td>
<td>ユーザーリクエスト時の自動キャッシュで補完</td>
</tr>
</tbody>
</table>
<h3 id="5-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3">5. セキュリティ</h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>キャッシュリフレッシュAPIの不正利用</td>
<td>サーバー負荷</td>
<td><code>X-Cache-Refresh-Key</code> ヘッダーで認証</td>
</tr>
</tbody>
</table>
<pre class="hljs"><code><div><span class="hljs-comment"># キャッシュリフレッシュAPIの認証</span>
secret_key = request.headers.get(<span class="hljs-string">"X-Cache-Refresh-Key"</span>)
<span class="hljs-keyword">if</span> secret_key != os.environ.get(<span class="hljs-string">"CACHE_REFRESH_SECRET_KEY"</span>):
    <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">"error"</span>: <span class="hljs-string">"Unauthorized"</span>}), <span class="hljs-number">401</span>
</div></code></pre>
<h2 id="%E9%81%8B%E7%94%A8">運用</h2>
<h3 id="%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E7%8A%B6%E6%85%8B%E3%81%AE%E7%A2%BA%E8%AA%8D">キャッシュ状態の確認</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># キャッシュステータス確認</span>
curl -H <span class="hljs-string">"X-Cache-Refresh-Key: YOUR_SECRET_KEY"</span> \
  <span class="hljs-string">"https://happle-reservation-backend.onrender.com/api/cache/status"</span>
</div></code></pre>
<h3 id="%E6%89%8B%E5%8B%95%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%83%AA%E3%83%95%E3%83%AC%E3%83%83%E3%82%B7%E3%83%A5">手動キャッシュリフレッシュ</h3>
<pre class="hljs"><code><div><span class="hljs-comment"># 特定店舗のキャッシュをリフレッシュ</span>
curl -X POST -H <span class="hljs-string">"X-Cache-Refresh-Key: YOUR_SECRET_KEY"</span> \
  <span class="hljs-string">"https://happle-reservation-backend.onrender.com/api/cache/refresh?days=14&amp;studio_ids=4"</span>
</div></code></pre>
<h3 id="github-actions-%E6%89%8B%E5%8B%95%E5%AE%9F%E8%A1%8C">GitHub Actions 手動実行</h3>
<ol>
<li>GitHub リポジトリの「Actions」タブを開く</li>
<li>「Refresh Cache」ワークフローを選択</li>
<li>「Run workflow」をクリック</li>
<li>パラメータを入力して実行</li>
</ol>
<h2 id="%E5%B0%86%E6%9D%A5%E3%81%AE%E6%8B%A1%E5%BC%B5%E6%A1%88">将来の拡張案</h2>
<h3 id="1-redis-%E3%81%B8%E3%81%AE%E7%A7%BB%E8%A1%8C">1. Redis への移行</h3>
<pre><code class="language-mermaid"><div class="mermaid">flowchart TB
    subgraph "現在"
        API1[Flask API] --> MEM[インメモリキャッシュ]
    end
    
    subgraph "将来"
        API2[Flask API] --> REDIS[(Redis)]
        API3[Flask API 2] --> REDIS
    end
</div></code></pre>
<p><strong>メリット</strong>:</p>
<ul>
<li>サーバー再起動でもキャッシュ維持</li>
<li>複数インスタンス間でキャッシュ共有</li>
<li>より高度なキャッシュ制御（LRU、パターン削除など）</li>
</ul>
<h3 id="2-cdn-%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5">2. CDN キャッシュ</h3>
<p>静的なデータ（店舗情報、プログラム情報）はCDNでキャッシュ可能。</p>
<h3 id="3-%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%82%A6%E3%82%A9%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0">3. キャッシュウォーミング</h3>
<p>営業開始前に全店舗のキャッシュを事前構築。</p>
<pre class="hljs"><code><div><span class="hljs-comment"># 例: 毎朝6時に全店舗キャッシュ</span>
<span class="hljs-attr">schedule:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">cron:</span> <span class="hljs-string">'0 6 * * *'</span>
</div></code></pre>
<h2 id="%E9%96%A2%E9%80%A3%E3%83%95%E3%82%A1%E3%82%A4%E3%83%AB">関連ファイル</h2>
<ul>
<li><code>happle-reservation/backend/app.py</code> - キャッシュ実装</li>
<li><code>.github/workflows/refresh-cache.yml</code> - cron設定</li>
<li><code>happle-reservation/env.example</code> - 環境変数</li>
</ul>
<h2 id="%E5%A4%89%E6%9B%B4%E5%B1%A5%E6%AD%B4">変更履歴</h2>
<table>
<thead>
<tr>
<th>日付</th>
<th>変更内容</th>
</tr>
</thead>
<tbody>
<tr>
<td>2025-12-25</td>
<td>初版作成</td>
</tr>
<tr>
<td>2025-12-25</td>
<td>週単位キャッシュ分割実装</td>
</tr>
<tr>
<td>2025-12-25</td>
<td>予約完了時のキャッシュリフレッシュ実装</td>
</tr>
<tr>
<td>2025-12-25</td>
<td>hacomono Webhook対応（予約・休憩・ブロック変更のリアルタイム反映）</td>
</tr>
</tbody>
</table>

</body>
</html>
