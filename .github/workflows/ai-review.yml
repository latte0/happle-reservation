name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'happle-reservation/frontend/**'
      - 'happle-reservation/backend/**'
      - 'happle-reservation/scripts/**'
      - 'terraform/**'
      - '.github/workflows/**'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # PRå†…ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
          grep -E '^(happle-reservation/(frontend|backend|scripts)/|terraform/|\.github/workflows/)' changed_files.txt > filtered_files.txt || true

          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          FILE_COUNT=$(wc -l < filtered_files.txt)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No relevant files changed"
            exit 0
          fi

          echo "Changed files:"
          cat filtered_files.txt

      - name: Get file diffs
        id: get-diffs
        if: steps.changed-files.outputs.file_count > 0
        run: |
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®diffã‚’å–å¾—ï¼ˆæœ€å¤§20ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾ç­–ï¼‰
          DIFF_OUTPUT=""
          COUNT=0
          MAX_FILES=20

          while IFS= read -r file && [ $COUNT -lt $MAX_FILES ]; do
            if [ -f "$file" ]; then
              echo "Processing: $file"
              DIFF_OUTPUT="${DIFF_OUTPUT}\n\n## File: $file\n"
              DIFF_OUTPUT="${DIFF_OUTPUT}\`\`\`diff\n"
              DIFF_OUTPUT="${DIFF_OUTPUT}$(git diff origin/${{ github.base_ref }}...HEAD -- "$file")\n"
              DIFF_OUTPUT="${DIFF_OUTPUT}\`\`\`\n"
              COUNT=$((COUNT + 1))
            fi
          done < filtered_files.txt

          # çµæœã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo -e "$DIFF_OUTPUT" > diffs.txt

          echo "Collected diffs for $COUNT files"

      - name: Review with Claude
        id: claude-review
        if: steps.changed-files.outputs.file_count > 0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          cat > prompt.txt << 'EOF'
          ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          1. **ãƒã‚°**: æ½œåœ¨çš„ãªãƒã‚°ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œ
          2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€èªè¨¼/èªå¯ã®å•é¡Œã€æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©å…¨ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é …ç›®ã«ã¤ã„ã¦
          3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: éåŠ¹ç‡ãªãƒ«ãƒ¼ãƒ—ã€ä¸è¦ãªAPIå‘¼ã³å‡ºã—ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
          4. **ã‚³ãƒ¼ãƒ‰å“è³ª**: å¯èª­æ€§ã€ä¿å®ˆæ€§ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é•å

          ## å‡ºåŠ›å½¢å¼
          Markdownå½¢å¼ã§ä»¥ä¸‹ã®æ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:

          ## ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
          - è¦‹ã¤ã‹ã£ãŸå•é¡Œã®ç·æ•°ã¨é‡è¦åº¦åˆ¥ã®å†…è¨³

          ## ğŸ”´ Critical Issues (è‡´å‘½çš„ãªå•é¡Œ)
          è‡´å‘½çš„ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã€‚å„å•é¡Œã«ã¤ã„ã¦:
          - **ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·**
          - å•é¡Œã®èª¬æ˜
          - ä¿®æ­£æ¡ˆ

          ## âš ï¸ Warnings (è­¦å‘Š)
          è­¦å‘Šãƒ¬ãƒ™ãƒ«ã®å•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã€‚

          ## âœ… è‰¯ã„ç‚¹
          è‰¯ã„å®Ÿè£…ãŒã‚ã‚Œã°ç°¡æ½”ã«è¨€åŠ

          ## ğŸ’¡ ææ¡ˆ
          å…¨ä½“çš„ãªæ”¹å–„ææ¡ˆãŒã‚ã‚Œã°è¨˜è¼‰

          å•é¡ŒãŒãªã„å ´åˆã¯ã€Œâœ… å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨ã ã‘è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚

          ---

          ## ã‚³ãƒ¼ãƒ‰å¤‰æ›´:
          EOF

          cat diffs.txt >> prompt.txt

          # Claude APIã‚’å‘¼ã³å‡ºã—
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @- << EOFCURL
          {
            "model": "claude-sonnet-4-5-20250929",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": $(jq -Rs . < prompt.txt)
              }
            ]
          }
          EOFCURL
          )

          # ãƒ‡ãƒãƒƒã‚°: APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡ºåŠ›
          echo "=== Claude API Response ==="
          echo "$RESPONSE" | jq '.' || echo "$RESPONSE"
          echo "==========================="

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’æŠ½å‡º
          REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text // "âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼"')

          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // .error.type')
            echo "âŒ Claude API Error: $ERROR_MSG"
            REVIEW="âŒ Claude APIã‚¨ãƒ©ãƒ¼: $ERROR_MSG"
          fi

          # GitHubã®è¤‡æ•°è¡Œå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œ
          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.changed-files.outputs.file_count > 0
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = `${{ steps.claude-review.outputs.review }}`;
            const body = `## ğŸ¤– AI Code Review by Claude\n\n${review}\n\n---\n*Powered by Claude 3.5 Sonnet*`;

            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– AI Code Review by Claude')
            );

            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
