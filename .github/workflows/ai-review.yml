name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'happle-reservation/frontend/**'
      - 'happle-reservation/backend/**'
      - 'happle-reservation/scripts/**'
      - 'terraform/**'
      - '.github/workflows/**'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # PRå†…ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
          grep -E '^(happle-reservation/(frontend|backend|scripts)/|terraform/|\.github/workflows/)' changed_files.txt > filtered_files.txt || true

          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          FILE_COUNT=$(wc -l < filtered_files.txt)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No relevant files changed"
            exit 0
          fi

          echo "Changed files:"
          cat filtered_files.txt

      - name: Get file diffs
        id: get-diffs
        if: steps.changed-files.outputs.file_count > 0
        run: |
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®diffã‚’å–å¾—ï¼ˆæœ€å¤§20ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾ç­–ï¼‰
          DIFF_OUTPUT=""
          COUNT=0
          MAX_FILES=20
          MAX_TOTAL_SIZE=100000  # ç´„10ä¸‡æ–‡å­—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾ç­–ï¼‰
          TOTAL_SIZE=0

          while IFS= read -r file && [ $COUNT -lt $MAX_FILES ]; do
            if [ -f "$file" ]; then
              # git diff ã®å¼•æ•°ã‚’ã‚¯ã‚©ãƒ¼ãƒˆã§ä¿è­·
              DIFF_CONTENT=$(git diff "origin/${{ github.base_ref }}...HEAD" -- "$file")
              DIFF_SIZE=${#DIFF_CONTENT}

              # ã‚µã‚¤ã‚ºåˆ¶é™ãƒã‚§ãƒƒã‚¯
              if [ $((TOTAL_SIZE + DIFF_SIZE)) -gt $MAX_TOTAL_SIZE ]; then
                echo "::warning::Reached size limit ($TOTAL_SIZE bytes). Skipping remaining files."
                break
              fi

              echo "Processing: $file (size: $DIFF_SIZE bytes)"
              DIFF_OUTPUT="${DIFF_OUTPUT}## File: $file"$'\n'
              DIFF_OUTPUT="${DIFF_OUTPUT}\`\`\`diff"$'\n'
              DIFF_OUTPUT="${DIFF_OUTPUT}${DIFF_CONTENT}"$'\n'
              DIFF_OUTPUT="${DIFF_OUTPUT}\`\`\`"$'\n'
              COUNT=$((COUNT + 1))
              TOTAL_SIZE=$((TOTAL_SIZE + DIFF_SIZE))
            fi
          done < filtered_files.txt

          echo "Total diff size: $TOTAL_SIZE bytes across $COUNT files"

          # çµæœã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo -e "$DIFF_OUTPUT" > diffs.txt

          echo "Collected diffs for $COUNT files"

      - name: Review with Claude
        id: claude-review
        if: steps.changed-files.outputs.file_count > 0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          set +x  # ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’æ˜ç¤ºçš„ã«ã‚ªãƒ•

          # APIã‚­ãƒ¼å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "::error::ANTHROPIC_API_KEY is not set"
            exit 1
          fi

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          cat > prompt.txt << 'EOF'
          ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œã§ç¾å®Ÿçš„ãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## çµ¶å¯¾ã«å®ˆã‚‹ã¹ãæŒ‡é‡
          - **ç¾çŠ¶ã®ã‚³ãƒ¼ãƒ‰ã§å®Ÿéš›ã«å•é¡ŒãŒç™ºç”Ÿã™ã‚‹å ´åˆã®ã¿**æŒ‡æ‘˜ã—ã¦ãã ã•ã„
          - ç†è«–çš„ãƒªã‚¹ã‚¯ã‚„ã€Œã‚‚ã—ã‹ã—ãŸã‚‰ã€ãƒ¬ãƒ™ãƒ«ã®æŒ‡æ‘˜ã¯**å®Œå…¨ã«ä¸è¦**ã§ã™
          - ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®æ¨™æº–æ©Ÿèƒ½ï¼ˆä¾‹: GitHub Actionsã®secretsãƒã‚¹ã‚­ãƒ³ã‚°ï¼‰ã‚’ç†è§£ã—ã€æ—¢ã«ä¿è­·ã•ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯æŒ‡æ‘˜ã—ãªã„
          - å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§æ¨å¥¨ã•ã‚Œã¦ã„ã‚‹å®Ÿè£…æ–¹æ³•ã¯å•é¡Œã¨ã—ã¦æŒ‡æ‘˜ã—ãªã„
          - ã‚³ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«ã€å‘½åè¦å‰‡ã€ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ææ¡ˆã¯**ä¸€åˆ‡ä¸è¦**ã§ã™
          - ã€Œã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã€ã¨ã„ã†ææ¡ˆã¯ã€ç¾çŠ¶ãŒ**å®Ÿéš›ã«å±é™ºãªå ´åˆã®ã¿**

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹ï¼ˆå³æ ¼ãªåŸºæº–ï¼‰
          1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**:
             - **ç¾æ™‚ç‚¹ã§å®Ÿéš›ã«æ”»æ’ƒå¯èƒ½**ãªSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€èªè¨¼ãƒã‚¤ãƒ‘ã‚¹
             - APIã‚­ãƒ¼ã‚„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ**å®Ÿéš›ã«ãƒ­ã‚°ã‚„å…¬é–‹ãƒªãƒã‚¸ãƒˆãƒªã«éœ²å‡ºã—ã¦ã„ã‚‹**å ´åˆ
             - ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®ä¿è­·æ©Ÿèƒ½ã§å®ˆã‚‰ã‚Œã¦ã„ã‚‹ã‚‚ã®ã¯æŒ‡æ‘˜ã—ãªã„

          2. **ãƒã‚°**:
             - **ç¢ºå®Ÿã«ã‚¨ãƒ©ãƒ¼ã‚„ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã‚’å¼•ãèµ·ã“ã™**ã‚³ãƒ¼ãƒ‰ã€æ˜ã‚‰ã‹ãªãƒ­ã‚¸ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼

          3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**:
             - **æ˜ã‚‰ã‹ã«é…ããªã‚‹**å®Ÿè£…ï¼ˆN+1ã‚¯ã‚¨ãƒªã€ç„¡é™ãƒ«ãƒ¼ãƒ—ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ãªã©ï¼‰

          4. **ãã®ä»–**:
             - å‹•ä½œã‚’å¦¨ã’ã‚‹è‡´å‘½çš„ãªå•é¡Œã®ã¿

          ## å‡ºåŠ›å½¢å¼
          å¿…ãšæœ€åˆã«ä»¶æ•°ã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º:

          ## ğŸ“Š ã‚µãƒãƒªãƒ¼
          - Critical Issues: Nä»¶
          - Warnings: Nä»¶

          å•é¡ŒãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã®ã¿ã€ä»¥ä¸‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º:

          ## ğŸ”´ Critical Issues (Nä»¶)
          æœ¬ç•ªç’°å¢ƒã§**ç¢ºå®Ÿã«å•é¡Œã«ãªã‚‹**è‡´å‘½çš„ãªå•é¡Œã®ã¿è¨˜è¼‰ã€‚
          - **ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·** - ç°¡æ½”ãªå•é¡Œèª¬æ˜ã¨ä¿®æ­£æ¡ˆ

          ## âš ï¸ Warnings (Nä»¶)
          **é«˜ç¢ºç‡ã§å•é¡Œã«ãªã‚‹**è­¦å‘Šã®ã¿è¨˜è¼‰ã€‚
          - **ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·** - ç°¡æ½”ãªå•é¡Œèª¬æ˜

          å•é¡ŒãŒãªã„å ´åˆã¯:
          ## ğŸ“Š ã‚µãƒãƒªãƒ¼
          - Critical Issues: 0ä»¶
          - Warnings: 0ä»¶

          âœ… é‡å¤§ãªå•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ

          ---

          ## ã‚³ãƒ¼ãƒ‰å¤‰æ›´:
          EOF

          cat diffs.txt >> prompt.txt

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          PROMPT_SIZE=$(wc -c < prompt.txt)
          MAX_PROMPT_SIZE=180000  # ç´„180KB (å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³è€ƒæ…®)

          if [ "$PROMPT_SIZE" -gt "$MAX_PROMPT_SIZE" ]; then
            echo "::warning::Prompt size ($PROMPT_SIZE bytes) exceeds limit. Truncating..."
            head -c $MAX_PROMPT_SIZE prompt.txt > prompt_truncated.txt
            mv prompt_truncated.txt prompt.txt
            echo -e "\n\n[... ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒåˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã¾ã—ãŸ ...]" >> prompt.txt
          fi

          echo "Final prompt size: $(wc -c < prompt.txt) bytes"

          # Claude APIã‚’å‘¼ã³å‡ºã—ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
          # APIã‚­ãƒ¼éœ²å‡ºé˜²æ­¢ã®ãŸã‚ã€curlå®Ÿè¡Œå‰ã«å†åº¦ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã‚’ã‚ªãƒ•
          set +x
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.json \
            --max-time 60 \
            --retry 3 \
            --retry-delay 5 \
            https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @- << EOFCURL
          {
            "model": "claude-sonnet-4-5-20250929",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": $(jq -Rs . < prompt.txt)
              }
            ]
          }
          EOFCURL
          )

          # HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "::error::Claude API returned status code: $HTTP_CODE"
            if [ "$HTTP_CODE" -eq 429 ]; then
              echo "::warning::Rate limit exceeded. Please try again later."
            elif [ "$HTTP_CODE" -eq 401 ]; then
              echo "::error::Authentication failed. Please check ANTHROPIC_API_KEY."
            elif [ "$HTTP_CODE" -eq 000 ]; then
              echo "::error::Network error or timeout occurred."
            fi
            REVIEW="âŒ Claude APIã‚¨ãƒ©ãƒ¼ (HTTP $HTTP_CODE): ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            echo "review<<DELIMITER_ERROR" >> $GITHUB_OUTPUT
            echo "$REVIEW" >> $GITHUB_OUTPUT
            echo "DELIMITER_ERROR" >> $GITHUB_OUTPUT
            exit 0  # PRã‚³ãƒ¡ãƒ³ãƒˆã¯æŠ•ç¨¿ã™ã‚‹ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯å¤±æ•—ã•ã›ãªã„
          fi

          RESPONSE=$(cat response.json)

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’æŠ½å‡ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
          if ! REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text' 2>/dev/null); then
            echo "::error::Failed to parse Claude API response"
            REVIEW="âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          fi

          # ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯
          if [ -z "$REVIEW" ] || [ "$REVIEW" = "null" ]; then
            REVIEW="âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹"
          fi

          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_TYPE=$(echo "$RESPONSE" | jq -r '.error.type // "unknown"')
            echo "âŒ Claude API Error Type: $ERROR_TYPE"
            REVIEW="âŒ Claude APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            # è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ GitHub Actions ã®ãƒ­ã‚°ã«ã®ã¿å‡ºåŠ›ï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
            echo "::warning::Claude API Error Details: $(echo "$RESPONSE" | jq -c '.error')"
          fi

          # GitHubã®è¤‡æ•°è¡Œå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œ
          DELIMITER="REVIEW_CONTENT_$(date +%s)"
          echo "review<<${DELIMITER}" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "${DELIMITER}" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.changed-files.outputs.file_count > 0
        uses: actions/github-script@v7
        env:
          REVIEW_CONTENT: ${{ steps.claude-review.outputs.review }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_CONTENT;
            const body = `## ğŸ¤– AI Code Review by Claude\n\n${review}\n\n---\n*Powered by Claude 3.5 Sonnet*`;

            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– AI Code Review by Claude')
            );

            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
