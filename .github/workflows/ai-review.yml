name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'happle-reservation/frontend/**'
      - 'happle-reservation/backend/**'
      - 'happle-reservation/scripts/**'
      - 'terraform/**'
      - '.github/workflows/**'

jobs:
  ai-review:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # PRå†…ã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å–å¾—
          git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt

          # ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
          grep -E '^(happle-reservation/(frontend|backend|scripts)/|terraform/|\.github/workflows/)' changed_files.txt > filtered_files.txt || true

          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          FILE_COUNT=$(wc -l < filtered_files.txt)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT

          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "No relevant files changed"
            exit 0
          fi

          echo "Changed files:"
          cat filtered_files.txt

      - name: Get file diffs
        id: get-diffs
        if: steps.changed-files.outputs.file_count > 0
        run: |
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã®diffã‚’å–å¾—ï¼ˆæœ€å¤§20ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾ç­–ï¼‰
          DIFF_OUTPUT=""
          COUNT=0
          MAX_FILES=20
          MAX_TOTAL_SIZE=100000  # ç´„10ä¸‡æ–‡å­—ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åˆ¶é™å¯¾ç­–ï¼‰
          TOTAL_SIZE=0

          while IFS= read -r file && [ $COUNT -lt $MAX_FILES ]; do
            if [ -f "$file" ]; then
              # git diff ã®å¼•æ•°ã‚’ã‚¯ã‚©ãƒ¼ãƒˆã§ä¿è­·
              DIFF_CONTENT=$(git diff "origin/${{ github.base_ref }}...HEAD" -- "$file")
              DIFF_SIZE=${#DIFF_CONTENT}

              # ã‚µã‚¤ã‚ºåˆ¶é™ãƒã‚§ãƒƒã‚¯
              if [ $((TOTAL_SIZE + DIFF_SIZE)) -gt $MAX_TOTAL_SIZE ]; then
                echo "::warning::Reached size limit ($TOTAL_SIZE bytes). Skipping remaining files."
                break
              fi

              echo "Processing: $file (size: $DIFF_SIZE bytes)"
              DIFF_OUTPUT="${DIFF_OUTPUT}## File: $file"$'\n'
              DIFF_OUTPUT="${DIFF_OUTPUT}\`\`\`diff"$'\n'
              DIFF_OUTPUT="${DIFF_OUTPUT}${DIFF_CONTENT}"$'\n'
              DIFF_OUTPUT="${DIFF_OUTPUT}\`\`\`"$'\n'
              COUNT=$((COUNT + 1))
              TOTAL_SIZE=$((TOTAL_SIZE + DIFF_SIZE))
            fi
          done < filtered_files.txt

          echo "Total diff size: $TOTAL_SIZE bytes across $COUNT files"

          # çµæœã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
          echo -e "$DIFF_OUTPUT" > diffs.txt

          echo "Collected diffs for $COUNT files"

      - name: Review with Claude
        id: claude-review
        if: steps.changed-files.outputs.file_count > 0
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
          cat > prompt.txt << 'EOF'
          ã‚ãªãŸã¯çµŒé¨“è±Šå¯Œãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

          ## ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
          1. **ãƒã‚°**: æ½œåœ¨çš„ãªãƒã‚°ã€ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å•é¡Œ
          2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€XSSã€èªè¨¼/èªå¯ã®å•é¡Œã€æ©Ÿå¯†æƒ…å ±ã®æ¼æ´©å…¨ã¦ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é …ç›®ã«ã¤ã„ã¦
          3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: éåŠ¹ç‡ãªãƒ«ãƒ¼ãƒ—ã€ä¸è¦ãªAPIå‘¼ã³å‡ºã—ã€ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯
          4. **ã‚³ãƒ¼ãƒ‰å“è³ª**: å¯èª­æ€§ã€ä¿å®ˆæ€§ã€ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é•å

          ## å‡ºåŠ›å½¢å¼
          Markdownå½¢å¼ã§ä»¥ä¸‹ã®æ§‹é€ ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:

          ## ğŸ“Š ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
          - ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°
          - è¦‹ã¤ã‹ã£ãŸå•é¡Œã®ç·æ•°ã¨é‡è¦åº¦åˆ¥ã®å†…è¨³

          ## ğŸ”´ Critical Issues (è‡´å‘½çš„ãªå•é¡Œ)
          è‡´å‘½çš„ãªå•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã€‚å„å•é¡Œã«ã¤ã„ã¦:
          - **ãƒ•ã‚¡ã‚¤ãƒ«å:è¡Œç•ªå·**
          - å•é¡Œã®èª¬æ˜
          - ä¿®æ­£æ¡ˆ

          ## âš ï¸ Warnings (è­¦å‘Š)
          è­¦å‘Šãƒ¬ãƒ™ãƒ«ã®å•é¡ŒãŒã‚ã‚‹å ´åˆã®ã¿ã“ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã€‚

          ## âœ… è‰¯ã„ç‚¹
          è‰¯ã„å®Ÿè£…ãŒã‚ã‚Œã°ç°¡æ½”ã«è¨€åŠ

          ## ğŸ’¡ ææ¡ˆ
          å…¨ä½“çš„ãªæ”¹å–„ææ¡ˆãŒã‚ã‚Œã°è¨˜è¼‰

          å•é¡ŒãŒãªã„å ´åˆã¯ã€Œâœ… å•é¡Œã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€ã¨ã ã‘è¨˜è¼‰ã—ã¦ãã ã•ã„ã€‚

          ---

          ## ã‚³ãƒ¼ãƒ‰å¤‰æ›´:
          EOF

          cat diffs.txt >> prompt.txt

          # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
          PROMPT_SIZE=$(wc -c < prompt.txt)
          MAX_PROMPT_SIZE=180000  # ç´„180KB (å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³è€ƒæ…®)

          if [ "$PROMPT_SIZE" -gt "$MAX_PROMPT_SIZE" ]; then
            echo "::warning::Prompt size ($PROMPT_SIZE bytes) exceeds limit. Truncating..."
            head -c $MAX_PROMPT_SIZE prompt.txt > prompt_truncated.txt
            mv prompt_truncated.txt prompt.txt
            echo -e "\n\n[... ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒåˆ‡ã‚Šè©°ã‚ã‚‰ã‚Œã¾ã—ãŸ ...]" >> prompt.txt
          fi

          echo "Final prompt size: $(wc -c < prompt.txt) bytes"

          # Claude APIã‚’å‘¼ã³å‡ºã—
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d @- << EOFCURL
          {
            "model": "claude-sonnet-4-5-20250929",
            "max_tokens": 4096,
            "messages": [
              {
                "role": "user",
                "content": $(jq -Rs . < prompt.txt)
              }
            ]
          }
          EOFCURL
          )

          # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’æŠ½å‡ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
          if ! REVIEW=$(echo "$RESPONSE" | jq -r '.content[0].text' 2>/dev/null); then
            echo "::error::Failed to parse Claude API response"
            REVIEW="âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
          fi

          # ç©ºãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯
          if [ -z "$REVIEW" ] || [ "$REVIEW" = "null" ]; then
            REVIEW="âŒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ç©ºã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹"
          fi

          # ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ‹ã‚¿ã‚¤ã‚ºï¼‰
          if echo "$RESPONSE" | jq -e '.error' > /dev/null 2>&1; then
            ERROR_TYPE=$(echo "$RESPONSE" | jq -r '.error.type // "unknown"')
            echo "âŒ Claude API Error Type: $ERROR_TYPE"
            REVIEW="âŒ Claude APIã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            # è©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯ GitHub Actions ã®ãƒ­ã‚°ã«ã®ã¿å‡ºåŠ›ï¼ˆPRã‚³ãƒ¡ãƒ³ãƒˆã«ã¯è¡¨ç¤ºã—ãªã„ï¼‰
            echo "::warning::Claude API Error Details: $(echo "$RESPONSE" | jq -c '.error')"
          fi

          # GitHubã®è¤‡æ•°è¡Œå‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œ
          DELIMITER="REVIEW_CONTENT_$(date +%s)"
          echo "review<<${DELIMITER}" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "${DELIMITER}" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.changed-files.outputs.file_count > 0
        uses: actions/github-script@v7
        env:
          REVIEW_CONTENT: ${{ steps.claude-review.outputs.review }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const review = process.env.REVIEW_CONTENT;
            const body = `## ğŸ¤– AI Code Review by Claude\n\n${review}\n\n---\n*Powered by Claude 3.5 Sonnet*`;

            // æ—¢å­˜ã®ãƒœãƒƒãƒˆã‚³ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ğŸ¤– AI Code Review by Claude')
            );

            if (botComment) {
              // æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
