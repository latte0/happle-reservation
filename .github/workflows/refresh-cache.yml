name: Refresh Cache

on:
  schedule:
    # 15分ごとに実行（UTC）- 無料枠節約
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # 手動実行も可能
    inputs:
      days:
        description: 'Number of days to cache (default: 14)'
        required: false
        default: '14'
        type: string
      studio_ids:
        description: 'Target studio IDs (comma-separated, e.g., 4,5,6). Empty = all studios'
        required: false
        default: '4'
        type: string

jobs:
  refresh:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Refresh cache
        run: |
          DAYS="${{ github.event.inputs.days || '14' }}"
          STUDIO_IDS="${{ github.event.inputs.studio_ids || '4' }}"
          
          echo "Refreshing cache for ${DAYS} days, studio_ids=${STUDIO_IDS}..."
          
          # Render backend URL
          API_BASE_URL="https://happle-reservation-backend.onrender.com"
          
          # Build query params
          QUERY="days=${DAYS}"
          if [ -n "$STUDIO_IDS" ]; then
            QUERY="${QUERY}&studio_ids=${STUDIO_IDS}"
          fi
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "X-Cache-Refresh-Key: ${{ secrets.CACHE_REFRESH_SECRET_KEY }}" \
            "${API_BASE_URL}/api/cache/refresh?${QUERY}")
          
          # レスポンスボディとHTTPステータスを分離
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "HTTP Status: ${HTTP_CODE}"
          echo "Response: ${BODY}"
          
          # ステータスコードに応じて成功/失敗を判定
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Cache refresh successful"
            exit 0
          elif [ "$HTTP_CODE" -eq 207 ]; then
            echo "⚠️ Cache refresh partially successful"
            exit 0
          else
            echo "❌ Cache refresh failed"
            exit 1
          fi

